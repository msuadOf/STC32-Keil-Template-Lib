C251 COMPILER V5.60.0,  MPU6500                                                            14/05/23  10:59:17  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE MPU6500
OBJECT MODULE PLACED IN .\MDK\Obj\MPU6500.obj
COMPILER INVOKED BY: D:\Program\Keil_v5\C251\BIN\C251.EXE CORE\Src\MPU6500.c XSMALL INTR2 OPTIMIZE(0,SPEED) BROWSE INCDI
                    -R(.\Driver;.\Driver\Inc;.\Driver\Isr;.\CORE\Inc;.\bsp\include) DEBUG PRINT(.\MDK\List\MPU6500.lst) TABS(2) OBJECT(.\MDK\
                    -Obj\MPU6500.obj) 

stmt  level    source

    1          #include <stdio.h>
    2          #include "MPU6500.h"
*** WARNING C317 IN LINE 39 OF \stc32\05_UART_lib\Driver\type_def.h: attempt to redefine macro 'NULL'
    3          /* Ñ¡ÔñÊ¹ÓÃSPI»¹ÊÇI2C½øÐÐÍ¨Ñ¶Äó£¬µ±¹ûÈ»ÊÇSPIÄå */
    4          #define MPU6500_USING_SPI
    5          // #define MPU6500_USING_I2C
    6          
    7          /**
    8           *
    9           * ********************************************************
   10           *
   11           *  ¼æÈÝ²ãÄó HAL_level start
   12           *
   13           * ********************************************************
   14           *
   15           **/
   16          
   17          /*
   18          ====================================
   19              ||
   20              ||
   21              ||  Ó²¼þÊµÏÖ²ã£¬¸ü¸ÄÉè±¸µÄ»°ÇëÔÚÕâÀï½øÐÐÊµÏÖ
   22              ||
   23              ||
   24          +++++++++++++++++++++++++++++++++++++++++++++++++++++++
   25          */
   26          #include "config.h"
   27          #include "bsp.h"
   28          /**
   29           * @brief Í³Ò»API½ÓÈë
   30           *
   31           */
   32          
   33          /* STC32G_Delay¿âÓÐÏà¹ØÊµÏÖº¯Êý½øÐÐÌæ´ú */
   34          #include "STC32G_Delay.h"
   35          void mpu6500_delay_ms(int ms)
   36          {
   37   1          delay_ms(ms);
   38   1      }
   39          #ifdef MPU6500_USING_SPI
   40          void hal_spi_init()
   41          {
   42   1          bsp_spi_init();
   43   1      }
   44          void hal_spi_read(unsigned char addr, unsigned char *buffer, int len)
   45          {
   46   1          bsp_spi_read(addr, buffer, len);
   47   1      }
   48          
   49          void hal_spi_write(unsigned char addr, unsigned char *buffer, int len)
   50          {
   51   1          bsp_spi_write(addr, buffer, len);
   52   1      }
   53          #endif
   54          
   55          #ifdef MPU6500_USING_I2C
               void hal_i2c_init()
C251 COMPILER V5.60.0,  MPU6500                                                            14/05/23  10:59:17  PAGE 2   

               {
                   I2C_soft_GPIO_Config();
               }
               void hal_i2c_read(unsigned char addr, unsigned char *buffer, int len)
               {
               }
               
               void hal_i2c_write(unsigned char addr, unsigned char *buffer, int len)
               {
               }
               #endif
   68          void MPU6500_Peripheral_Init()
   69          {
   70   1      #ifdef MPU6500_USING_I2C
                   hal_i2c_init();
               #endif
   73   1      #ifdef MPU6500_USING_SPI
   74   1          hal_spi_init();
   75   1      #endif
   76   1      }
   77          void MPU6500_Read(unsigned char addr, unsigned char *buffer, int len)
   78          {
   79   1      #ifdef MPU6500_USING_I2C
                   hal_i2c_read(addr, buffer, len);
               #endif
   82   1      #ifdef MPU6500_USING_SPI
   83   1          hal_spi_read(addr, buffer, len);
   84   1      #endif
   85   1      }
   86          
   87          void MPU6500_Write(unsigned char addr, unsigned char *buffer, int len)
   88          {
   89   1      #ifdef MPU6500_USING_I2C
                   hal_i2c_write(addr, buffer, len);
               #endif
   92   1      #ifdef MPU6500_USING_SPI
   93   1          hal_spi_write(addr, buffer, len);
   94   1      #endif
   95   1      }
   96          /**
   97           * *******************************************
   98           *
   99           *  ¼æÈÝ²ãÄó end
  100           *
  101           * *******************************************
  102           * */
  103          
  104          
  105          
  106          void MPU6500_Write_u8(unsigned char addr, u8 buffer){
  107   1          u8 reg_buffer=buffer;
  108   1        MPU6500_Write(MPU6500_GYRO_CONFIG,&reg_buffer,1);
  109   1      }
*** WARNING C47 IN LINE 106 OF CORE\Src\MPU6500.c: 'addr': unreferenced parameter
  110          // void MPU6500_Write_u16(unsigned char addr, u16 *buffer){
  111          //     u8 buffer_u8[2];
  112          //     buffer_u8[]
  113          //     MPU6500_Write(addr, buffer, 1);
  114          // }
  115          // void MPU6500_Write_u32(unsigned char addr, u32 *buffer){
  116          
  117          // }
  118          /* ¶¨ÒåMPU6500³õÊ¼»¯º¯Êý */
  119          void MPU6500_Init()
  120          {
  121   1          unsigned char reg_buffer;
C251 COMPILER V5.60.0,  MPU6500                                                            14/05/23  10:59:17  PAGE 3   

  122   1      
  123   1          MPU6500_Peripheral_Init();
  124   1      
  125   1          // /* ÉèÖÃÍÓÂÝÒÇ²ÉÑùÂÊÎª1KHz */
  126   1          // reg_buffer = 0x00; //·ÖÆµÏµÊýÎª0
  127   1          // MPU6500_Write(MPU6500_SMPLRT_DIV, &reg_buffer, 1);
  128   1      
  129   1          // /* ÉèÖÃ¼ÓËÙ¶È¼Æ²ÉÑùÂÊÎª1KHz */
  130   1          // reg_buffer = 0x00; //·ÖÆµÏµÊýÎª0
  131   1          // MPU6500_Write(MPU6500_ACCEL_CONFIG, &reg_buffer, 1);
  132   1      
  133   1          /* ÉèÖÃÍÓÂÝÒÇ×Ô¼ì */
  134   1          reg_buffer = 0x80;
  135   1          MPU6500_Write(MPU6500_SELF_TEST_X_GYRO, &reg_buffer, 1);
  136   1          // µÈ´ý100ms£¬ÈÃÍÓÂÝÒÇÍê³É×Ô¼ì
  137   1          delay_ms(40);
  138   1      
  139   1          /* ¹Ø±ÕÍÓÂÝÒÇ×Ô¼ì */
  140   1          reg_buffer = 0x00;
  141   1          MPU6500_Write(MPU6500_SELF_TEST_X_GYRO, &reg_buffer, 1);
  142   1      
  143   1          /* ´ò¿ªÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼Æ */
  144   1          reg_buffer = 0x00;
  145   1          MPU6500_Write(MPU6500_PWR_MGMT_1, &reg_buffer, 1);
  146   1      
  147   1              reg_buffer = MPU6500_GYRO_FS_SEL_500dps;
  148   1          MPU6500_Write(MPU6500_GYRO_CONFIG, &reg_buffer, 1);
  149   1      }
  150          
  151          // /* ¶¨ÒåMPU6500ÁùÖáÊý¾Ý»ñÈ¡º¯Êý */
  152          // void MPU6500_get_buffer(float *gyro_buffer, float *acc_buffer)
  153          // {
  154          //     unsigned char buf[14];
  155          
  156          //     /* ¶ÁÈ¡ÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼ÆÊý¾Ý */
  157          //     MPU6500_Read(MPU6500_ACCEL_XOUT_H, buf, (3 + 1 + 3) * 2); // 3¸ögyroÖáÊý¾Ý+1¸ötempÊý¾Ý+3¸öaccÊý¾Ý
  158          
  159          //     /* ½âÎöÍÓÂÝÒÇÊý¾Ý */
  160          //     gyro_buffer[0] = (float)(((short)buf[8] << 8) | buf[9]) / 32768.0f * 250.0f;
  161          //     gyro_buffer[1] = (float)(((short)buf[10] << 8) | buf[11]) / 32768.0f * 250.0f;
  162          //     gyro_buffer[2] = (float)(((short)buf[12] << 8) | buf[13]) / 32768.0f * 250.0f;
  163          
  164          //     /* ½âÎö¼ÓËÙ¶È¼ÆÊý¾Ý */
  165          //     acc_buffer[0] = (float)(((short)buf[0] << 8) | buf[1]) / 32768.0f * 2.0f;
  166          //     acc_buffer[1] = (float)(((short)buf[2] << 8) | buf[3]) / 32768.0f * 2.0f;
  167          //     acc_buffer[2] = (float)(((short)buf[4] << 8) | buf[5]) / 32768.0f * 2.0f;
  168          // }
  169          
  170          void MPU6500_get_buffer(float *gyro_buffer, float *acc_buffer)
  171          {
  172   1          static float gyroLast[3] = {0, 0, 0}; // ÉÏÒ»´ÎµÄÍÓÂÝÒÇÊý¾Ý
  173   1          static float accLast[3] = {0, 0, 0}; // ÉÏÒ»´ÎµÄ¼ÓËÙ¶È¼ÆÊý¾Ý
  174   1      
  175   1          unsigned char buf[14];
  176   1              float alphaGyro = 0.5f; // ÍÓÂÝÒÇÊý¾ÝµÄÂË²¨ÏµÊý
  177   1              float alphaAcc = 0.5f; // ¼ÓËÙ¶È¼ÆÊý¾ÝµÄÂË²¨ÏµÊý
  178   1      
  179   1          /* ¶ÁÈ¡ÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼ÆÊý¾Ý */
  180   1          MPU6500_Read(MPU6500_ACCEL_XOUT_H, buf, (3 + 1 + 3) * 2); // 3¸ögyroÖáÊý¾Ý+1¸ötempÊý¾Ý+3¸öaccÊý¾Ý
  181   1      
  182   1          /* ½âÎöÍÓÂÝÒÇÊý¾Ý£¬Ê¹ÓÃ»¥²¹ÂË²¨Æ½»¬Êý¾Ý */
  183   1      
  184   1          gyro_buffer[0] = (float)(((short)buf[8] << 8) | buf[9]) / 32768.0f * 500.0f;
  185   1          gyro_buffer[1] = (float)(((short)buf[10] << 8) | buf[11]) / 32768.0f * 500.0f;
  186   1          gyro_buffer[2] = (float)(((short)buf[12] << 8) | buf[13]) / 32768.0f * 500.0f;
  187   1          gyro_buffer[0] = alphaGyro * gyroLast[0] + (1 - alphaGyro) * gyro_buffer[0];
C251 COMPILER V5.60.0,  MPU6500                                                            14/05/23  10:59:17  PAGE 4   

  188   1          gyro_buffer[1] = alphaGyro * gyroLast[1] + (1 - alphaGyro) * gyro_buffer[1];
  189   1          gyro_buffer[2] = alphaGyro * gyroLast[2] + (1 - alphaGyro) * gyro_buffer[2];
  190   1          gyroLast[0] = gyro_buffer[0];
  191   1          gyroLast[1] = gyro_buffer[1];
  192   1          gyroLast[2] = gyro_buffer[2];
  193   1      
  194   1          // /* ½âÎö¼ÓËÙ¶È¼ÆÊý¾Ý£¬Ê¹ÓÃ»¥²¹ÂË²¨Æ½»¬Êý¾Ý */
  195   1      
  196   1          // acc_buffer[0] = (float)(((short)buf[0] << 8) | buf[1]) / 32768.0f * 2.0f;
  197   1          // acc_buffer[1] = (float)(((short)buf[2] << 8) | buf[3]) / 32768.0f * 2.0f;
  198   1          // acc_buffer[2] = (float)(((short)buf[4] << 8) | buf[5]) / 32768.0f * 2.0f;
  199   1          // acc_buffer[0] = alphaAcc * accLast[0] + (1 - alphaAcc) * acc_buffer[0];
  200   1          // acc_buffer[1] = alphaAcc * accLast[1] + (1 - alphaAcc) * acc_buffer[1];
  201   1          // acc_buffer[2] = alphaAcc * accLast[2] + (1 - alphaAcc) * acc_buffer[2];
  202   1          // accLast[0] = acc_buffer[0];
  203   1          // accLast[1] = acc_buffer[1];
  204   1          // accLast[2] = acc_buffer[2];
  205   1      }
*** WARNING C47 IN LINE 170 OF CORE\Src\MPU6500.c: 'acc_buffer': unreferenced parameter
  206          
  207          
  208          // int main()
  209          // {
  210          //     float gyro_buffer[3], acc_buffer[3];
  211          
  212          //     /* ³õÊ¼»¯MPU6500 */
  213          //     mpu6500_init();
  214          
  215          //     while (1)
  216          //     {
  217          //         /* »ñÈ¡ÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼ÆÊý¾Ý */
  218          //         mpu6500_get_buffer(gyro_buffer, acc_buffer);
  219          
  220          //         /* ´òÓ¡Êý¾Ý */
  221          //         printf("Gyro: %.2f, %.2f, %.2f, Acc: %.2f, %.2f, %.2f\n", gyro_buffer[0], gyro_buffer[1], gyro
             -_buffer[2], acc_buffer[0], acc_buffer[1], acc_buffer[2]);
  222          
  223          //         /* ÑÓÊ±Ò»¶ÎÊ±¼ä */
  224          //         delay_ms(10);
  225          //     }
  226          
  227          //     return 0;
  228          // }
  229          
  230          //void MPU6500_SelfCalibration(void)
  231          //{
  232          //    unsigned char buffer;
  233          //    unsigned char rawData[6];      // Ô­Ê¼´«¸ÐÆ÷Êý¾Ý
  234          //    float gyroBias[3] = {0, 0, 0}; // ÍÓÂÝÒÇÆ«ÖÃ
  235          //    int i, j;
  236          //    // ¼ÓËÙ¶È¼Æ×ÔÐ£×¼
  237          //    float accelBias[3] = {0, 0, 0}; // ¼ÓËÙ¶È¼ÆÆ«ÖÃ
  238          
  239          //    // ÎÂ¶ÈÎÈ¶¨»¯
  240          //    buffer = 0x40;
  241          //    MPU6500_Write(0x1A, &buffer, 1); // ½«Config¼Ä´æÆ÷µÄTEMP_FIFO_ENÎ»ÖÃÎª1£¬Ê¹ÄÜÎÂ¶È´«¸ÐÆ÷
  242          //    mpu6500_delay_ms(200);           // µÈ´ý200ms£¬ÈÃÎÂ¶ÈÎÈ¶¨
  243          
  244          //    // ÍÓÂÝÒÇ×ÔÐ£×¼
  245          //    for (i = 0; i < 1000; i++) // È¡1000¸öÑù±¾½øÐÐÆ½¾ùÖµ¼ÆËã
  246          //    {
  247          //        MPU6500_Read(0x43, rawData, 6); // ¶ÁÈ¡ÍÓÂÝÒÇX¡¢Y¡¢ZÖáµÄÔ­Ê¼Êý¾Ý
  248          //        for (j = 0; j < 3; j++)
  249          //        {
  250          //            gyroBias[j] += (float)(((int16_t)rawData[j * 2] << 8) | rawData[j * 2 + 1]); // ÀÛ¼ÓÃ¿¸öÖáµ
             -ÄÔ­Ê¼Êý¾Ý
C251 COMPILER V5.60.0,  MPU6500                                                            14/05/23  10:59:17  PAGE 5   

  251          //        }
  252          //        mpu6500_delay_ms(10);
  253          //    }
  254          //    for (i = 0; i < 3; i++)
  255          //    {
  256          //        gyroBias[i] /= 1000.0f; // ¼ÆËãÆ½¾ùÖµ
  257          //    }
  258          //    MPU6500_Write(0x13, (unsigned char *)&gyroBias[0], 2); // ½«ÍÓÂÝÒÇXÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄGYRO_X_
             -OFFS_HºÍGYRO_X_OFFS_L¼Ä´æÆ÷ÖÐ
  259          //    MPU6500_Write(0x15, (unsigned char *)&gyroBias[1], 2); // ½«ÍÓÂÝÒÇYÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄGYRO_Y_
             -OFFS_HºÍGYRO_Y_OFFS_L¼Ä´æÆ÷ÖÐ
  260          //    MPU6500_Write(0x17, (unsigned char *)&gyroBias[2], 2); // ½«ÍÓÂÝÒÇZÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄGYRO_Z_
             -OFFS_HºÍGYRO_Z_OFFS_L¼Ä´æÆ÷ÖÐ
  261          
  262          //    // ¼ÓËÙ¶È¼Æ×ÔÐ£×¼
  263          //    for (i = 0; i < 500; i++) // È¡500¸öÑù±¾½øÐÐÆ½¾ùÖµ¼ÆËã
  264          //    {
  265          //        MPU6500_Read(0x3B, rawData, 6); // ¶ÁÈ¡¼ÓËÙ¶È¼ÆX¡¢Y¡¢ZÖáµÄÔ­Ê¼Êý¾Ý
  266          //        for (j = 0; j < 3; j++)
  267          //        {
  268          //            accelBias[j] += (float)(((int16_t)rawData[j * 2] << 8) | rawData[j * 2 + 1]); // ÀÛ¼ÓÃ¿¸öÖá
             -µÄÔ­Ê¼Êý¾Ý
  269          //        }
  270          //        mpu6500_delay_ms(10);
  271          //    }
  272          //    for (i = 0; i < 3; i++)
  273          //    {
  274          //        accelBias[i] /= 500.0f; // ¼ÆËãÆ½¾ùÖµ
  275          //    }
  276          //    accelBias[2] -= 16384.0f;                               // ¼õÈ¥1gÖØÁ¦¼ÓËÙ¶È¶ÔZÖáµÄÓ°Ïì
  277          
  278          //    MPU6500_Write(0x06, (unsigned char *)&accelBias[0], 2); // ½«¼ÓËÙ¶È¼ÆXÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄACCE
             -L_X_OFFS_HºÍACCEL_X_OFFS_L¼Ä´æÆ÷ÖÐ
  279          //    MPU6500_Write(0x08, (unsigned char *)&accelBias[1], 2); // ½«¼ÓËÙ¶È¼ÆYÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄACCE
             -L_Y_OFFS_HºÍACCEL_Y_OFFS_L¼Ä´æÆ÷ÖÐ
  280          //    MPU6500_Write(0x0A, (unsigned char *)&accelBias[2], 2); // ½«¼ÓËÙ¶È¼ÆZÖáµÄÆ«ÖÃÐ´ÈëMPU6500Ð¾Æ¬µÄACCE
             -L_Z_OFFS_HºÍACCEL_Z_OFFS_L¼Ä´æÆ÷ÖÐ
  281          //}
  282          
  283          //void MPU6500_GYRO_CONFIG(){
  284          //    MPU6500_Write_u8(MPU6500_GYRO_CONFIG,MPU6500_GYRO_FS_SEL_250dps);
  285          //}


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       660     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        83     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        32     ------
End of Module Information.


C251 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
